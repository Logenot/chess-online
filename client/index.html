<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online Chess Game</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
  />
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px }
    #board { width: 400px; margin: 20px auto }
    #overlay, #leaderboardOverlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.7); color: white;
      display:flex; align-items:center; justify-content:center;
      flex-direction: column; font-size:1.5rem; visibility:hidden;
    }
    button { padding:10px 20px; margin:5px; font-size:1rem; }
    #leaderboardTable {
      background: white; color: black; border-collapse: collapse;
      width: 80%; max-width:600px; margin:20px auto;
    }
    #leaderboardTable th, td { border:1px solid #ccc; padding:8px; }
    #leaderboardTable th { background:#eee; }
  </style>
</head>
<body>
  <h1>Online Chess Game</h1>

  <div id="lobby">
    <input id="nicknameInput" placeholder="Enter your nickname" />
    <input id="roomInput" placeholder="Enter room ID" />
    <button id="joinRoom">Join Room</button>
    <button id="findOpponent">Find Opponent</button>
    <button id="showLeaderboard">Show Leaderboard</button>
  </div>

  <div id="board"></div>

  <div id="overlay">
    <div id="resultText"></div>
    <button id="returnBtn">Return to Lobby</button>
  </div>

  <div id="leaderboardOverlay">
    <h2>Top 10 Players</h2>
    <table id="leaderboardTable">
      <thead>
        <tr><th>#</th><th>Nick</th><th>Wins</th><th>Win %</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="closeLbBtn">Close</button>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script>
    const socket = io('https://chess-online-production-79dd.up.railway.app');
    let currentRoom, playerColor, nickname, playersInfo = [];
    const game = new Chess();

    // Элементы
    const nickInput = document.getElementById('nicknameInput');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinRoom');
    const findBtn = document.getElementById('findOpponent');
    const showLbBtn = document.getElementById('showLeaderboard');
    const lobby = document.getElementById('lobby');
    const boardDiv = document.getElementById('board');
    const overlay = document.getElementById('overlay');
    const resultText = document.getElementById('resultText');
    const returnBtn = document.getElementById('returnBtn');
    const lbOverlay = document.getElementById('leaderboardOverlay');
    const lbBody = document.querySelector('#leaderboardTable tbody');
    const closeLbBtn = document.getElementById('closeLbBtn');

    // Join by room ID
    joinBtn.onclick = () => {
      nickname = nickInput.value.trim();
      const roomId = roomInput.value.trim();
      if (!nickname) return alert('Enter nickname');
      if (!roomId) return alert('Enter room ID');
      socket.emit('joinRoom', { roomId, nickname });
    };

    // Find random opponent
    findBtn.onclick = () => {
      nickname = nickInput.value.trim();
      if (!nickname) return alert('Enter nickname');
      socket.emit('findMatch', { nickname });
      findBtn.disabled = true;
      findBtn.textContent = 'Searching…';
    };

    // Leaderboard
    showLbBtn.onclick = async () => {
      try {
        const res = await fetch('https://chess-online-production-79dd.up.railway.app/leaderboard', { credentials: 'include' });
        const data = await res.json();
        lbBody.innerHTML = '';
        data.slice(0,10).forEach((p,i) => {
          const rate = p.totalGames ? ((p.wins/p.totalGames*100).toFixed(1)) : '0.0';
          lbBody.innerHTML += `<tr><td>${i+1}</td><td>${p.nickname}</td><td>${p.wins}</td><td>${rate}%</td></tr>`;
        });
        lbOverlay.style.visibility = 'visible';
      } catch {
        alert('Failed to load leaderboard');
      }
    };
    closeLbBtn.onclick = () => lbOverlay.style.visibility = 'hidden';
    returnBtn.onclick = () => window.location.reload();

    // При обновлении списка игроков в комнате
    socket.on('roomUpdate', ({ players }) => {
      playersInfo = players;
      const idx = playersInfo.findIndex(p => p.id === socket.id);
      if (idx === 0) playerColor = 'white';
      else if (idx === 1) playerColor = 'black';
      else {
        alert('Room is full, you are spectator');
        return;
      }
      currentRoom = Object.keys(rooms => rooms).find(id => Boolean(rooms[id]?.some(p=>p.id===socket.id)));
      lobby.style.display = 'none';
      initBoard();
    });

    // При матч-файнде
    socket.on('matchFound', ({ roomId, color, players }) => {
      currentRoom = roomId;
      playerColor = color;
      playersInfo = players;
      lobby.style.display = 'none';
      findBtn.disabled = false;
      findBtn.textContent = 'Find Opponent';
      initBoard();
    });

    // Инициализация доски
    function initBoard() {
      boardDiv.innerHTML = '';
      window.board = Chessboard('board', {
        draggable: true,
        orientation: playerColor,
        position: 'start',
        pieceTheme: p => `img/chesspieces/${p}.png`,
        onDragStart: (s,p) => {
          const isW = p.startsWith('w');
          if ((playerColor==='white' && !isW) || (playerColor==='black' && isW)) return false;
        },
        onDrop: handleMove,
      });
    }

    // Проверка конца игры
    function checkGameOver(showOnly = false) {
      if (!game.game_over()) return;
      const text = game.in_checkmate()
        ? (game.turn() === playerColor[0] ? 'Checkmate! You lost.' : 'Checkmate! You won!')
        : 'Draw.';
      resultText.textContent = text;
      overlay.style.visibility = 'visible';
      if (!showOnly && game.in_checkmate()) {
        const opp = playersInfo.find(p => p.id !== socket.id);
        const winner = (game.turn()===playerColor[0] ? opp.nickname : nickname);
        const loser  = (game.turn()===playerColor[0] ? nickname : opp.nickname);
        socket.emit('gameOver', { roomId: currentRoom, winner, loser });
      }
    }

    // Делимся ходом
    function handleMove(src, tgt) {
      const m = game.move({ from: src, to: tgt, promotion: 'q' });
      if (!m) return 'snapback';
      window.board.position(game.fen());
      socket.emit('move', { roomId: currentRoom, move: m });
      checkGameOver(false);
    }

    // Ход от соперника
    socket.on('move', ({ from, to }) => {
      game.move({ from, to, promotion: 'q' });
      window.board.position(game.fen());
      checkGameOver(true);
    });
  </script>
</body>
</html>
