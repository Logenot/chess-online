<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Online Chess Game</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
  />
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px }
    #board { width: 400px; margin: 20px auto }
    #overlay, #leaderboardOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); color: white;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; font-size: 1.5rem; visibility: hidden;
    }
    button { padding: 10px 20px; margin: 5px; font-size: 1rem; }
    #leaderboardTable { background: white; color: black; border-collapse: collapse; width: 80%; max-width: 600px; margin: 0 auto; }
    #leaderboardTable th, #leaderboardTable td { border: 1px solid #ccc; padding: 8px; }
    #leaderboardTable th { background: #eee; }
  </style>
</head>
<body>
  <h1>Online Chess Game</h1>

  <div id="lobby">
    <input type="text" id="nicknameInput" placeholder="Введите никнейм" />
    <button id="findOpponent">Найти соперника</button>
    <button id="showLeaderboard">Показать рейтинг</button>
  </div>

  <div id="board"></div>

  <div id="overlay">
    <div id="resultText"></div>
    <button id="returnBtn">Вернуться в лобби</button>
  </div>

  <div id="leaderboardOverlay">
    <h2>Топ-10 игроков</h2>
    <table id="leaderboardTable">
      <thead>
        <tr><th>#</th><th>Ник</th><th>Wins</th><th>Win %</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button id="closeLbBtn">Закрыть</button>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script>
    const socket = io('https://chess-online-production-79dd.up.railway.app');
    let currentRoom, playerColor, nickname, playersInfo;
    const game = new Chess();

    // DOM
    const nickInput = document.getElementById('nicknameInput');
    const findBtn = document.getElementById('findOpponent');
    const showLbBtn = document.getElementById('showLeaderboard');
    const lobby = document.getElementById('lobby');
    const boardDiv = document.getElementById('board');
    const overlay = document.getElementById('overlay');
    const resultText = document.getElementById('resultText');
    const returnBtn = document.getElementById('returnBtn');
    const lbOverlay = document.getElementById('leaderboardOverlay');
    const lbBody = document.querySelector('#leaderboardTable tbody');
    const closeLbBtn = document.getElementById('closeLbBtn');

    findBtn.onclick = () => {
      nickname = nickInput.value.trim();
      if (!nickname) return alert('Введите никнейм');
      socket.emit('findMatch', { nickname });
      findBtn.disabled = true;
      findBtn.textContent = 'Ищем…';
    };

    showLbBtn.onclick = async () => {
      try {
        const res = await fetch('https://chess-online-production-79dd.up.railway.app/leaderboard', { credentials: 'include' });
        const data = await res.json();
        lbBody.innerHTML = '';
        data.slice(0,10).forEach((p,i) => {
          const rate = p.totalGames ? (p.wins/p.totalGames*100).toFixed(1) : '0.0';
          lbBody.innerHTML += `<tr><td>${i+1}</td><td>${p.nickname}</td><td>${p.wins}</td><td>${rate}%</td></tr>`;
        });
        lbOverlay.style.visibility = 'visible';
      } catch {
        alert('Не удалось загрузить рейтинг');
      }
    };
    closeLbBtn.onclick = () => lbOverlay.style.visibility = 'hidden';
    returnBtn.onclick = () => location.reload(); // перезагрузить страницу, чтобы сбросить состояние

    // По матчу
    socket.on('matchFound', ({ roomId, color, players }) => {
      currentRoom = roomId;
      playerColor = color;
      playersInfo = players;
      lobby.style.display = 'none';
      initBoard();
    });

    // Инициализация доски
    function initBoard() {
      boardDiv.innerHTML = '';
      Chessboard('board', {
        draggable: true,
        orientation: playerColor,
        position: 'start',
        onDragStart: (s,p) => {
          const isW = p.startsWith('w');
          if ((playerColor==='white' && !isW) || (playerColor==='black' && isW)) return false;
        },
        onDrop: handleMove,
      });
    }

    function checkGameOver(showOnly=false) {
      if (!game.game_over()) return;
      let txt = game.in_checkmate()
        ? (game.turn()===playerColor[0] ? 'Мат! Вы проиграли.' : 'Мат! Вы победили!')
        : 'Ничья.';
      resultText.textContent = txt;
      overlay.style.visibility = 'visible';
      if (!showOnly && game.in_checkmate()) {
        const me = socket.id;
        const opp = playersInfo.find(p=>p.id!==me);
        const winner = (game.turn()===playerColor[0]) ? opp.nickname : nickname;
        const loser  = (game.turn()===playerColor[0]) ? nickname : opp.nickname;
        socket.emit('gameOver', { roomId: currentRoom, winner, loser });
      }
    }

    function handleMove(src, tgt) {
      const mv = game.move({ from: src, to: tgt, promotion: 'q' });
      if (!mv) return 'snapback';
      Chessboard('board').position(game.fen());
      socket.emit('move', { roomId: currentRoom, move: mv });
      checkGameOver(false);
    }

    socket.on('move', ({ from, to }) => {
      game.move({ from, to, promotion: 'q' });
      Chessboard('board').position(game.fen());
      checkGameOver(true);
    });
  </script>
</body>
</html>
